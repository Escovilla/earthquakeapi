<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Philippines Earthquake Monitor (30 days)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --sidebar-width: 340px;
            --bg: #fafafa;
            --muted: #666
        }

        html,
        body,
        #app {
            height: 100%;
            margin: 0
        }

        body {
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: var(--bg);
            color: #111
        }

        .app {
            display: flex;
            height: 100vh
        }

        aside {
            width: var(--sidebar-width);
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.03);
            background: #fff;
            padding: 18px;
            overflow: auto
        }

        main {
            flex: 1;
            position: relative
        }

        #map {
            position: absolute;
            inset: 0
        }

        h1 {
            font-size: 18px;
            margin: 0 0 6px
        }

        p.lead {
            margin: 0 0 12px;
            color: var(--muted);
            font-size: 13px
        }

        .loading {
            padding: 8px;
            background: #fff7;
            display: inline-block;
            border-radius: 6px;
            margin-bottom: 12px
        }

        ul.events {
            list-style: none;
            padding: 0;
            margin: 8px 0
        }

        ul.events li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0
        }

        .mag {
            font-weight: 700;
            margin-right: 8px
        }

        .small {
            font-size: 12px;
            color: var(--muted)
        }

        .legend {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px
        }

        .legend .item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px
        }

        .dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block
        }

        footer.note {
            font-size: 12px;
            color: var(--muted);
            margin-top: 12px
        }

        .controls {
            margin-top: 10px
        }

        a.link {
            color: #0b63d6;
            text-decoration: none
        }

        .zoom-controls {
            margin-top: 8px;
            display: flex;
            gap: 8px
        }

        button.zoom-btn {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #ccc;
            background: #fff;
            border-radius: 4px;
            cursor: pointer
        }

        button.zoom-btn:hover {
            background: #f5f5f5
        }

        @media(max-width:800px) {
            aside {
                width: 320px
            }
        }

        /* Sidebar toggle button */
        .toggle-btn {
            position: absolute;
            top: 78px;
            left: 10px;
            z-index: 1000;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            font-size: 16px;
        }

        .toggle-btn:hover {
            background: #f0f0f0;
        }

        /* Collapsed sidebar state */
        .sidebar-collapsed aside {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            position: absolute;
            /* keep map layout intact */
            z-index: 1000;
        }

        /* Main map stays the same size */
        .sidebar-collapsed main {
            flex: 1;
            /* unchanged */
        }

        aside {
            transition: transform 0.3s ease;
        }
    </style>
</head>

<body>
    <div id="app" class="app">
        <aside>
            <h1>Philippines Earthquake Monitor</h1>
            <p class="lead">Showing all earthquakes from today up to the past 30 days within the Philippine region (USGS feed)</p>

            <div id="status" class="small"></div>

            <div class="controls">
                <label class="small">Minimum magnitude: <span id="minMagLabel">0.0</span></label>
                <input id="minMag" type="range" min="0" max="8" step="0.1" value="0" style="width:100%" />
            </div>

            <div class="legend">
                <div class="item"><span class="dot" style="background:#FED976"></span><span class="small">0 - 1.9</span></div>
                <div class="item"><span class="dot" style="background:#FEB24C"></span><span class="small">2 - 2.9</span></div>
                <div class="item"><span class="dot" style="background:#FD8D3C"></span><span class="small">3 - 3.9</span></div>
                <div class="item"><span class="dot" style="background:#FC4E2A"></span><span class="small">4 - 4.9</span></div>
                <div class="item"><span class="dot" style="background:#E31A1C"></span><span class="small">5 - 5.9</span></div>
                <div class="item"><span class="dot" style="background:#BD0026"></span><span class="small">6 - 6.9</span></div>
                <div class="item"><span class="dot" style="background:#800026"></span><span class="small">7+</span></div>
            </div>

            <h3 style="margin-top:12px;margin-bottom:6px">Events (<span id="count">0</span>)</h3>
            <div id="listWrap">
                <div id="loading" class="loading">Loading data…</div>
                <ul id="events" class="events"></ul>
            </div>

            <footer class="note">Data: <a class="link" href="https://earthquake.usgs.gov/" target="_blank" rel="noopener">USGS</a> · Map: OpenStreetMap</footer>
        </aside>
        <main>
            <button id="toggleSidebar" class="toggle-btn">☰</button>
            <div id="map"></div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- <script>

        const API_URL = 'http://localhost:3000/api/earthquakes';

        function magnitudeToColor(m, ageDays) {
            const baseColor =
                m >= 7 ? '#800026' :
                    m >= 6 ? '#BD0026' :
                        m >= 5 ? '#E31A1C' :
                            m >= 4 ? '#FC4E2A' :
                                m >= 3 ? '#FD8D3C' :
                                    m >= 2 ? '#FEB24C' :
                                        '#FED976';
            const opacityFactor = Math.max(0.3, 1 - ageDays / 30);
            return { color: baseColor, opacity: opacityFactor };
        }

        function magToRadiusMeters(m) {
            return Math.max(150, Math.pow(m, 2) * 300);
        }

        const map = L.map('map', { center: [12.8797, 121.774], zoom: 6 });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const markerLayer = L.layerGroup().addTo(map);

        const statusEl = document.getElementById('status');
        const eventsEl = document.getElementById('events');
        const countEl = document.getElementById('count');
        const loadingEl = document.getElementById('loading');

        let earthquakeData = [];

        async function fetchData() {
            loadingEl.style.display = 'inline-block';
            statusEl.textContent = 'Fetching data...';
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error('Network error');
                const j = await res.json();

                earthquakeData = (j.earthquakes || []).filter(ev => ev.lat && ev.lon);

                statusEl.textContent = `Loaded ${earthquakeData.length} events (last 30 days)`;
                updateDisplay();
            } catch (err) {
                console.error(err);
                statusEl.textContent = 'Failed to fetch earthquake data';
                earthquakeData = [];
                updateDisplay();
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        function clearMarkers() {
            markerLayer.clearLayers();
        }

        function updateDisplay() {
            const minMag = parseFloat(document.getElementById('minMag').value) || 0;
            document.getElementById('minMagLabel').textContent = minMag.toFixed(1);

            clearMarkers();
            eventsEl.innerHTML = '';

            const visible = earthquakeData.filter(ev => ev.mag >= minMag);
            countEl.textContent = visible.length;

            const latlngs = [];
            const now = Date.now();

            visible.forEach(ev => {
                const { lat, lon, mag, place, date } = ev;
                const ageDays = 0; // custom API already filters by last 30 days

                const { color, opacity } = magnitudeToColor(mag, ageDays);
                const radius = magToRadiusMeters(mag);

                const circle = L.circle([lat, lon], {
                    radius,
                    color,
                    weight: 1,
                    fillOpacity: opacity
                }).addTo(markerLayer);

                const label = `${place || 'Unknown, Philippines'}<br/>Mag: ${mag} ⚠️<br/>Date: ${date}`;
                circle.bindPopup(`<div>${label}</div>`);

                const li = document.createElement('li');
                li.innerHTML = `<span class="mag">${mag}</span> <span>${place || 'Unknown, Philippines'}</span><div class="small">${date}</div>`;
                li.style.cursor = 'pointer';
                li.addEventListener('click', () => {
                    map.setView([lat, lon], 8);
                    circle.openPopup();
                });
                eventsEl.appendChild(li);

                latlngs.push([lat, lon]);
            });

            if (latlngs.length) {
                try {
                    map.fitBounds(latlngs, { padding: [40, 40], maxZoom: 9 });
                } catch (e) {
                    console.warn('fitBounds failed', e);
                }
            }
        }

        document.getElementById('minMag').addEventListener('input', updateDisplay);

        fetchData();
        setInterval(fetchData, 5 * 60 * 1000);

        // Sidebar toggle functionality
        const toggleBtn = document.getElementById('toggleSidebar');
        const appContainer = document.getElementById('app');
        const sidebar = document.querySelector('aside');

        toggleBtn.addEventListener('click', () => {
            const isCollapsed = appContainer.classList.toggle('sidebar-collapsed');
            toggleBtn.textContent = isCollapsed ? '☰' : '×';

            // Wait for CSS transition to complete, then rerender the map
            sidebar.addEventListener('transitionend', function handler() {
                map.invalidateSize(); // Forces Leaflet to recalc map size
                sidebar.removeEventListener('transitionend', handler);
            });
        });
    </script> -->
    <script>
        const API_URL = 'http://localhost:3000/api/earthquakes';

        function magnitudeToColor(m, ageDays) {
            const baseColor =
                m >= 7 ? '#800026' :
                    m >= 6 ? '#BD0026' :
                        m >= 5 ? '#E31A1C' :
                            m >= 4 ? '#FC4E2A' :
                                m >= 3 ? '#FD8D3C' :
                                    m >= 2 ? '#FEB24C' :
                                        '#FED976';
            const opacityFactor = Math.max(0.3, 1 - ageDays / 30);
            return { color: baseColor, opacity: opacityFactor };
        }

        function magToRadiusMeters(m) {
            return Math.max(150, Math.pow(m, 2) * 300);
        }

        // Remove prefixes like "123 km N 45° E of " from place names
        function cleanPlace(place) {
            if (!place) return 'Unknown, Philippines';
            // Remove everything up to the last " of "
            const index = place.toLowerCase().lastIndexOf(' of ');
            if (index === -1) return place.trim(); // no "of", return as is
            return place.slice(index + 4).trim(); // everything after " of "
        }


        const map = L.map('map', { center: [12.8797, 121.774], zoom: 6 });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const markerLayer = L.layerGroup().addTo(map);

        const statusEl = document.getElementById('status');
        const eventsEl = document.getElementById('events');
        const countEl = document.getElementById('count');
        const loadingEl = document.getElementById('loading');

        let earthquakeData = [];

        async function fetchData() {
            loadingEl.style.display = 'inline-block';
            statusEl.textContent = 'Fetching data...';
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error('Network error');
                const j = await res.json();

                earthquakeData = (j.earthquakes || []).filter(ev => ev.lat && ev.lon);

                statusEl.textContent = `Loaded ${earthquakeData.length} events (last 30 days + previous month)`;
                updateDisplay();
            } catch (err) {
                console.error(err);
                statusEl.textContent = 'Failed to fetch earthquake data';
                earthquakeData = [];
                updateDisplay();
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        function clearMarkers() {
            markerLayer.clearLayers();
        }

        function updateDisplay() {
            const minMag = parseFloat(document.getElementById('minMag').value) || 0;
            document.getElementById('minMagLabel').textContent = minMag.toFixed(1);

            clearMarkers();
            eventsEl.innerHTML = '';

            const visible = earthquakeData.filter(ev => ev.mag >= minMag);
            countEl.textContent = visible.length;

            const latlngs = [];
            const now = Date.now();

            visible.forEach(ev => {
                const { lat, lon, mag, place: rawPlace, date } = ev;
                const place = cleanPlace(rawPlace);

                const ageDays = 0;
                const { color, opacity } = magnitudeToColor(mag, ageDays);
                const radius = magToRadiusMeters(mag);

                const circle = L.circle([lat, lon], {
                    radius,
                    color,
                    weight: 1,
                    fillOpacity: opacity
                }).addTo(markerLayer);

                const label = `${place}<br/>Mag: ${mag} ⚠️<br/>Date: ${date}`;
                circle.bindPopup(`<div>${label}</div>`);

                // Determine ⚠️ and color
                const showWarning = mag >= 5 ? '⚠️ ' : '';
                // Red intensity based on magnitude (5 → light red, 7+ → dark red)
                const redIntensity = Math.min(255, 100 + (mag - 5) * 75);
                const magColor = mag >= 5 ? `rgb(${redIntensity},0,0)` : '#111';

                const li = document.createElement('li');
                li.innerHTML = `<span class="mag" style="color:${magColor}">${showWarning}${mag}</span> <span style="color:${magColor}">${place}</span><div class="small">${date}</div>`;
                li.style.cursor = 'pointer';
                li.addEventListener('click', () => {
                    map.setView([lat, lon], 8);
                    circle.openPopup();
                });
                eventsEl.appendChild(li);

                latlngs.push([lat, lon]);
            });

            if (latlngs.length) {
                try {
                    map.fitBounds(latlngs, { padding: [40, 40], maxZoom: 9 });
                } catch (e) {
                    console.warn('fitBounds failed', e);
                }
            }
        }

        // Min magnitude filter
        document.getElementById('minMag').addEventListener('input', updateDisplay);

        // Fetch every 5 minutes
        fetchData();
        setInterval(fetchData, 5 * 60 * 1000);

        // Sidebar toggle functionality
        const toggleBtn = document.getElementById('toggleSidebar');
        const appContainer = document.getElementById('app');
        const sidebar = document.querySelector('aside');

        toggleBtn.addEventListener('click', () => {
            const isCollapsed = appContainer.classList.toggle('sidebar-collapsed');
            toggleBtn.textContent = isCollapsed ? '☰' : '×';

            // Wait for CSS transition to complete, then rerender the map
            sidebar.addEventListener('transitionend', function handler() {
                map.invalidateSize();
                sidebar.removeEventListener('transitionend', handler);
            });
        });
    </script>


</body>

</html>
