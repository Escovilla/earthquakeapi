<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Philippines Earthquake Monitor (60 days)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --sidebar-width: 340px;
            --bg: #fafafa;
            --muted: #666
        }

        html,
        body,
        #app {
            height: 100%;
            margin: 0;
            font-weight: 100;
        }

        body {
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: var(--bg);
            color: #ffffff;
        }

        .app {
            display: flex;
            height: 100vh;
        }

        aside {
            width: var(--sidebar-width);
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 18px;
            overflow: auto;
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        main {
            flex: 1;
            position: relative;
            z-index: 0;
        }

        #map {
            position: absolute;
            inset: 0;
        }

        h1 {
            font-size: 22px;
            font-weight: 400;
            margin: 0 0 6px;
        }

        p.lead {
            margin: 0 0 12px;
            color: #ffffff;
            font-size: 13px;
        }

        .loading {
            padding: 8px;
            background: #fff7;
            display: inline-block;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        ul.events {
            list-style: none;
            padding: 0;
            margin: 8px 0;
        }

        ul.events li {
            padding: 8px 0;
            border-bottom: 0.1px solid #f0f0f0;
        }

        .mag {
            font-weight: 700;
            margin-right: 8px;
        }

        .small {
            font-size: 12px;
            color: #ffffff;
        }

        .legend {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .legend .item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
        }

        footer.note {
            font-size: 12px;
            color: #ffffff;
            margin-top: 12px;
        }

        .controls {
            margin-top: 10px;
        }

        a.link {
            color: #0b63d6;
            text-decoration: none;
        }

        .toggle-btn {
            position: absolute;
            top: 6px;
            left: calc(var(--sidebar-width) + 42px);
            z-index: 1100;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            font-size: 16px;
            transition: left 0.3s ease;
        }

        .sidebar-collapsed aside {
            transform: translateX(-100%);
        }

        .sidebar-collapsed .toggle-btn {
            left: 50px;
            top: 12px;
        }

        .leaflet-popup-content-wrapper {
            background-color: rgba(255, 255, 255, 0.15) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 10px;
            color: #fff;
        }

        .leaflet-popup-tip {
            background-color: rgba(255, 255, 255, 0.15) !important;
            backdrop-filter: blur(10px);
        }
    </style>
</head>

<body>
    <div id="app" class="app frosted-glass">
        <button id="toggleSidebar" class="toggle-btn">☰</button>
        <aside>
            <h1>Philippine Earthquake Monitor</h1>
            <p class="lead">Showing all earthquakes from today up to the past 60 days within the Philippine region PHIVOLCS feed</p>

            <div id="status" class="small"></div>

            <div class="controls">
                <label class="small">Minimum magnitude: <span id="minMagLabel">0.0</span></label>
                <input id="minMag" type="range" min="0" max="8" step="0.1" value="0" style="width:100%" />
            </div>

            <!-- Fault line toggle -->
            <div class="controls">
                <label class="small">
                    <input type="checkbox" id="toggleFaults" checked />
                    Show active faults
                </label>
            </div>

            <div class="legend">
                <div class="item"><span class="dot" style="background:#FED976"></span><span class="small">0 - 1.9</span></div>
                <div class="item"><span class="dot" style="background:#FEB24C"></span><span class="small">2 - 2.9</span></div>
                <div class="item"><span class="dot" style="background:#FD8D3C"></span><span class="small">3 - 3.9</span></div>
                <div class="item"><span class="dot" style="background:#FC4E2A"></span><span class="small">4 - 4.9</span></div>
                <div class="item"><span class="dot" style="background:#E31A1C"></span><span class="small">5 - 5.9</span></div>
                <div class="item"><span class="dot" style="background:#BD0026"></span><span class="small">6 - 6.9</span></div>
                <div class="item"><span class="dot" style="background:#800026"></span><span class="small">7+</span></div>
            </div>

            <h4 style="margin-top:12px;margin-bottom:6px;font-weight:100;">Events (<span id="count">0</span>)</h4>
            <div id="listWrap">
                <div id="loading" class="loading">Loading data…</div>
                <ul id="events" class="events"></ul>
            </div>

            <footer class="note">Data: <a class="link" href="https://earthquake.phivolcs.dost.gov.ph/" target="_blank" rel="noopener">PHIVOLCS</a> · Map: OpenStreetMap</footer>
        </aside>

        <main>
            <div id="map"></div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="./faults.js"></script>

    <script>
        const API_URL = 'https://damp-haze-8f5e.escovillanico.workers.dev/api/earthquakes';

        const map = L.map('map', {
            center: [12.8797, 121.774],
            zoom: 6
        });

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        const markerLayer = L.layerGroup().addTo(map);
        const faultLayer = L.layerGroup().addTo(map);

        // ======== ADD FAULTS =========
        function loadFaults() {
            if (typeof faultsData === 'undefined') return;
            faultLayer.clearLayers();

            faultsData.forEach(collection => {
                L.geoJSON(collection, {
                    style: {
                        color: '#ff3333',
                        weight: 0.5,
                        opacity: 0.8,
                    },
                    onEachFeature: function (feature, layer) {
                        const props = feature.properties || {};
                        layer.bindPopup(`<strong>${props.d_fname || 'Active Fault'}</strong><br>${props.d_segname || ''}`);
                    }
                }).addTo(faultLayer);
            });
        }

        loadFaults();

        // Toggle fault visibility
        document.getElementById('toggleFaults').addEventListener('change', e => {
            if (e.target.checked) {
                map.addLayer(faultLayer);
            } else {
                map.removeLayer(faultLayer);
            }
        });

        // ======== EARTHQUAKE FETCH + RENDER =========
        const statusEl = document.getElementById('status');
        const eventsEl = document.getElementById('events');
        const countEl = document.getElementById('count');
        const loadingEl = document.getElementById('loading');

        let earthquakeData = [];

        function magnitudeToColor(m, ageDays) {
            const baseColor =
                m >= 7 ? '#800026' :
                    m >= 6 ? '#BD0026' :
                        m >= 5 ? '#E31A1C' :
                            m >= 4 ? '#FC4E2A' :
                                m >= 3 ? '#FD8D3C' :
                                    m >= 2 ? '#FEB24C' :
                                        '#FED976';
            const opacityFactor = Math.max(0.3, 1 - ageDays / 30);
            return { color: baseColor, opacity: opacityFactor };
        }

        function magToRadiusMeters(m) {
            return Math.max(150, Math.pow(m, 2) * 300);
        }

        function cleanPlace(place) {
            if (!place) return 'Unknown, Philippines';
            const index = place.toLowerCase().lastIndexOf(' of ');
            return index === -1 ? place.trim() : place.slice(index + 4).trim();
        }

        async function fetchData() {
            loadingEl.style.display = 'inline-block';
            statusEl.textContent = 'Fetching data...';
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error('Network error');
                const j = await res.json();
                earthquakeData = (j.earthquakes || []).filter(ev => ev.lat && ev.lon);
                statusEl.textContent = `Loaded ${earthquakeData.length} events`;
                updateDisplay();
            } catch (err) {
                console.error(err);
                statusEl.textContent = 'Failed to fetch earthquake data';
                earthquakeData = [];
                updateDisplay();
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        function clearMarkers() {
            markerLayer.clearLayers();
        }

        function updateDisplay() {
            const minMag = parseFloat(document.getElementById('minMag').value) || 0;
            document.getElementById('minMagLabel').textContent = minMag.toFixed(1);

            clearMarkers();
            eventsEl.innerHTML = '';

            const visible = earthquakeData.filter(ev => ev.mag >= minMag);
            countEl.textContent = visible.length;

            const latlngs = [];
            visible.forEach(ev => {
                const { lat, lon, mag, place: rawPlace, date } = ev;
                const place = cleanPlace(rawPlace);
                const { color, opacity } = magnitudeToColor(mag, 0);
                const radius = magToRadiusMeters(mag);

                const circle = L.circle([lat, lon], {
                    radius,
                    color,
                    weight: 0.1,
                    fillOpacity: opacity
                }).addTo(markerLayer);

                const label = `${place}<br/>Magnitude: ${mag}<br/>Date: ${date}`;
                circle.bindPopup(`<div>${label}</div>`);

                const showWarning = mag >= 5 ? '⚠️ ' : '';
                const redIntensity = Math.min(255, 100 + (mag - 5) * 75);
                const magColor = mag >= 5 ? `rgb(${redIntensity},0,0)` : '#ffffffba';

                const li = document.createElement('li');
                li.innerHTML = `<span class="mag" style="color:${magColor}">${showWarning}${mag}</span><span style="color:${magColor}">${place}</span><div class="small">${date}</div>`;
                li.style.cursor = 'pointer';
                li.addEventListener('click', () => {
                    map.setView([lat + 0.1, lon], 8);
                    circle.openPopup();
                    toggleSidebar();
                });
                eventsEl.appendChild(li);
                latlngs.push([lat, lon]);
            });

            if (latlngs.length) {
                map.fitBounds(latlngs, { padding: [40, 40], maxZoom: 9 });
            }
        }

        document.getElementById('minMag').addEventListener('input', updateDisplay);
        fetchData();
        setInterval(fetchData, 5 * 60 * 1000);

        const toggleSidebar = () => {
            const toggleBtn = document.getElementById('toggleSidebar');
            const appContainer = document.getElementById('app');
            const sidebar = document.querySelector('aside');
            const isCollapsed = appContainer.classList.toggle('sidebar-collapsed');
            toggleBtn.textContent = isCollapsed ? '☰' : '×';
            sidebar.addEventListener('transitionend', function handler() {
                map.invalidateSize();
                sidebar.removeEventListener('transitionend', handler);
            });
        };

        document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
    </script>
</body>

</html>
